{% extends "base.html" %}

{% block title %}Panel de Novedades{% endblock %}

{% block header %}Panel de Novedades{% endblock %}

{% block content %}
<div class="fade-in-up">
  <!-- Header Section -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
    <div class="flex-grow-1">
      <h1 class="h3 mb-2 d-flex align-items-center gap-3">
        <div class="avatar bg-primary bg-opacity-15 rounded-3 p-2">
          <i class="bi bi-megaphone-fill text-primary fs-3"></i>
        </div>
        <div>
          <span class="fw-bold">Panel de Novedades</span>
          <div class="text-muted small mt-1">Env√≠a mensajes y avisos a los empleados</div>
        </div>
      </h1>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <button onclick="showHistory()" class="btn btn-outline-primary d-flex align-items-center gap-2">
        <i class="bi bi-clock-history"></i>
        <span class="d-none d-sm-inline">Historial</span>
      </button>

      <button onclick="clearForm()" class="btn btn-outline-secondary d-flex align-items-center gap-2">
        <i class="bi bi-x-circle"></i>
        <span class="d-none d-sm-inline">Limpiar</span>
      </button>
    </div>
  </div>

  <div class="row g-4">
    <!-- Message Composer -->
    <div class="col-xl-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-gradient-primary text-white border-0">
          <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="bi bi-pencil-square me-2"></i>
            Redactar Mensaje
          </h5>
        </div>

        <div class="card-body p-4">
          <form id="messageForm" class="needs-validation" novalidate>
            <!-- Recipients Selection -->
            <div class="mb-4">
              <label class="form-label fw-semibold d-flex align-items-center gap-2 mb-3">
                <i class="bi bi-people-fill text-primary"></i>
                Destinatarios
                <span class="badge bg-primary ms-2" id="recipientsCount">0 seleccionados</span>
              </label>

              <!-- Quick Select Buttons -->
              <div class="d-flex flex-wrap gap-2 mb-3">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllEmployees()">
                  <i class="bi bi-check-circle me-1"></i>Todos los empleados
                </button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="selectBySector('entrega')">
                  <i class="bi bi-truck me-1"></i>Entrega
                </button>
                <button type="button" class="btn btn-sm btn-outline-info" onclick="selectBySector('almac√©n')">
                  <i class="bi bi-box-seam me-1"></i>Almac√©n
                </button>
                <button type="button" class="btn btn-sm btn-outline-warning" onclick="selectBySector('administraci√≥n')">
                  <i class="bi bi-clipboard-data me-1"></i>Administraci√≥n
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectBySector('mantenimiento')">
                  <i class="bi bi-tools me-1"></i>Mantenimiento
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSelection()">
                  <i class="bi bi-x-circle me-1"></i>Limpiar
                </button>
              </div>

              <!-- Employee Search and Selection -->
              <div class="recipient-selector border rounded-3 p-3 bg-light">
                <div class="input-group mb-3">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search text-muted"></i>
                  </span>
                  <input type="text" class="form-control border-start-0 ps-0"
                         id="employeeSearch" placeholder="Buscar empleados por nombre o DNI..."
                         autocomplete="off">
                  <button class="btn btn-outline-secondary" type="button" onclick="toggleEmployeeList()">
                    <i class="bi bi-chevron-down" id="toggleIcon"></i>
                  </button>
                </div>

                <div class="employee-list-container" id="employeeListContainer" style="display: none;">
                  <div class="employee-list border rounded-2 bg-white p-2" style="max-height: 300px; overflow-y: auto;">
                    {% for empleado in empleados %}
                    <div class="employee-item form-check d-flex align-items-center p-2 rounded-2 mb-1"
                         data-dni="{{ empleado.dni }}"
                         data-name="{{ empleado.nombre }}"
                         data-sector="{{ empleado.sector }}">
                      <input class="form-check-input me-3" type="checkbox"
                             value="{{ empleado.dni }}" id="emp_{{ empleado.dni }}">
                      <label class="form-check-label flex-grow-1 d-flex align-items-center cursor-pointer" for="emp_{{ empleado.dni }}">
                        <div class="avatar-wrapper me-3">
                          <img src="{{ url_for('imagen_chofer', dni=empleado.dni) }}"
                               alt="Foto de {{ empleado.nombre }}"
                               class="avatar-img rounded-circle"
                               onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIGZpbGw9IiNmMWY1ZjkiIHJ4PSIxNiIvPjx0ZXh0IHg9IjE2IiB5PSIxOSIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzlhYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VTwvdGV4dD48L3N2Zz4=';">
                        </div>
                        <div class="flex-grow-1">
                          <div class="fw-semibold">{{ empleado.nombre }}</div>
                          <div class="text-muted small">DNI: {{ empleado.dni }}</div>
                        </div>
                        <div class="sector-badge">
                          {% if empleado.sector == 'entrega' %}
                            <span class="badge bg-primary bg-opacity-10 text-primary">Entrega</span>
                          {% elif empleado.sector == 'almac√©n' %}
                            <span class="badge bg-success bg-opacity-10 text-success">Almac√©n</span>
                          {% elif empleado.sector == 'administraci√≥n' %}
                            <span class="badge bg-warning bg-opacity-10 text-warning">Admin</span>
                          {% elif empleado.sector == 'mantenimiento' %}
                            <span class="badge bg-secondary bg-opacity-10 text-secondary">Manten</span>
                          {% else %}
                            <span class="badge bg-light text-dark">{{ empleado.sector[:6] }}</span>
                          {% endif %}
                        </div>
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                </div>

                <!-- Selected Recipients Display -->
                <div id="selectedRecipients" class="selected-recipients mt-3" style="display: none;">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <span class="fw-semibold small">Seleccionados:</span>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSelection()">
                      <i class="bi bi-x-circle me-1"></i>Quitar todos
                    </button>
                  </div>
                  <div id="recipientsTags" class="d-flex flex-wrap gap-1"></div>
                </div>
              </div>
            </div>

            <!-- Message Content -->
            <div class="mb-4">
              <label for="messageContent" class="form-label fw-semibold d-flex align-items-center gap-2">
                <i class="bi bi-chat-text-fill text-success"></i>
                Contenido del Mensaje
                <span class="text-danger">*</span>
              </label>
              <div class="message-editor">
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="bi bi-pencil text-muted"></i>
                  </span>
                  <textarea class="form-control border-start-0 ps-0"
                           id="messageContent" name="mensaje" rows="4"
                           placeholder="Escribe tu mensaje aqu√≠..."
                           maxlength="500" required></textarea>
                  <div class="invalid-feedback">
                    Por favor escribe un mensaje v√°lido.
                  </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    M√°ximo 500 caracteres
                  </small>
                  <small class="text-muted" id="charCount">0/500</small>
                </div>
              </div>
            </div>

            <!-- Message Preview -->
            <div class="mb-4" id="messagePreview" style="display: none;">
              <label class="form-label fw-semibold d-flex align-items-center gap-2">
                <i class="bi bi-eye text-info"></i>
                Vista Previa
              </label>
              <div class="preview-card border rounded-3 p-3 bg-light">
                <div class="d-flex align-items-start gap-3">
                  <div class="avatar bg-primary rounded-circle d-flex align-items-center justify-content-center text-white fw-bold" style="width: 40px; height: 40px;">
                    <i class="bi bi-bell"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-semibold text-primary mb-1">Notificaci√≥n de la Empresa</div>
                    <div class="preview-content text-dark" id="previewText"></div>
                    <div class="text-muted small mt-2">
                      <i class="bi bi-clock me-1"></i>
                      Enviado ahora
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex flex-column flex-sm-row gap-2 pt-3 border-top">
              <button type="button" class="btn btn-outline-info flex-fill" onclick="togglePreview()">
                <i class="bi bi-eye me-1"></i>
                Vista Previa
              </button>

              <button type="button" class="btn btn-outline-secondary flex-fill" onclick="saveDraft()">
                <i class="bi bi-save me-1"></i>
                Guardar Borrador
              </button>

              <button type="submit" class="btn btn-primary flex-fill" id="sendButton" disabled>
                <i class="bi bi-send me-1"></i>
                <span id="sendText">Enviar Mensaje</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Sidebar with Stats and History -->
    <div class="col-xl-4">
      <div class="row g-3">
        <!-- Today's Message Statistics -->
        <div class="col-12">
          <div class="card border-0 shadow-sm stat-card">
            <div class="card-header bg-gradient-primary text-white border-0">
              <h6 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-bar-chart-line me-2"></i>
                Estad√≠sticas de Mensajes - Hoy
              </h6>
            </div>
            <div class="card-body p-4">
              <div class="row g-4">
                <!-- Total Messages Today -->
                <div class="col-md-6 col-lg-3">
                  <div class="text-center">
                    <div class="stat-icon mb-2">
                      <i class="bi bi-send-check-fill text-primary fs-1"></i>
                    </div>
                    <div class="stat-number display-6 fw-bold text-primary mb-1">{{ estadisticas_hoy.total }}</div>
                    <div class="stat-label text-muted small">Mensajes enviados hoy</div>
                  </div>
                </div>

                <!-- Comparison with Yesterday -->
                <div class="col-md-6 col-lg-3">
                  <div class="text-center">
                    <div class="stat-icon mb-2">
                      <i class="bi bi-calendar-minus text-info fs-1"></i>
                    </div>
                    <div class="stat-number h4 fw-bold text-info mb-1">{{ estadisticas_hoy.comparacion.ayer }}</div>
                    <div class="stat-label text-muted small">Mensajes ayer</div>
                    {% if estadisticas_hoy.comparacion.ayer > 0 %}
                      {% set porcentaje = ((estadisticas_hoy.total - estadisticas_hoy.comparacion.ayer) / estadisticas_hoy.comparacion.ayer * 100)|round(1) %}
                      <div class="small mt-1 {% if porcentaje >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <i class="bi bi-arrow-{% if porcentaje >= 0 %}up{% else %}down{% endif %} me-1"></i>
                        {{ porcentaje }}%
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Messages by Sector -->
                <div class="col-md-6 col-lg-3">
                  <div class="text-center">
                    <div class="stat-icon mb-2">
                      <i class="bi bi-diagram-3-fill text-success fs-1"></i>
                    </div>
                    <div class="stat-number h4 fw-bold text-success mb-1">{{ estadisticas_hoy.por_sector|length }}</div>
                    <div class="stat-label text-muted small">Sectores alcanzados</div>
                    {% if estadisticas_hoy.por_sector %}
                      <div class="small text-muted mt-1">
                        {% for sector, cantidad in estadisticas_hoy.por_sector.items() %}
                          <span class="badge bg-success bg-opacity-10 text-success me-1">{{ sector[:3] }}:{{ cantidad }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <!-- Messages by Branch -->
                <div class="col-md-6 col-lg-3">
                  <div class="text-center">
                    <div class="stat-icon mb-2">
                      <i class="bi bi-building-fill text-warning fs-1"></i>
                    </div>
                    <div class="stat-number h4 fw-bold text-warning mb-1">{{ estadisticas_hoy.por_sucursal|length }}</div>
                    <div class="stat-label text-muted small">Sucursales alcanzadas</div>
                    {% if estadisticas_hoy.por_sucursal %}
                      <div class="small text-muted mt-1">
                        {% for sucursal, cantidad in estadisticas_hoy.por_sucursal.items() %}
                          <span class="badge bg-warning bg-opacity-10 text-warning me-1">{{ sucursal[:6] }}:{{ cantidad }}</span>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Progress Bar -->
              <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Progreso del d√≠a</span>
                  <span class="small text-muted">{{ estadisticas_hoy.total }} mensajes</span>
                </div>
                <div class="progress" style="height: 6px;">
                  {% set progreso = (estadisticas_hoy.total / 50 * 100)|round if estadisticas_hoy.total > 0 else 0 %}
                  <div class="progress-bar bg-primary" style="width: {{ progreso }}%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Messages with Enhanced Info -->
        <div class="col-12">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-gradient-success text-white border-0 d-flex justify-content-between align-items-center">
              <h6 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-clock-history me-2"></i>
                Mensajes Recientes
              </h6>
              <span class="badge bg-white bg-opacity-20 text-white">{{ avisos|length }} total</span>
            </div>
            <div class="card-body p-0">
              <div class="list-group list-group-flush" id="recentMessages">
                {% for aviso in avisos %}
                <div class="list-group-item px-3 py-3 border-0 hover-lift">
                  <div class="d-flex align-items-start gap-3">
                    <div class="avatar-wrapper flex-shrink-0">
                      <div class="avatar bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center text-success fw-bold" style="width: 40px; height: 40px;">
                        {% if aviso.nombre %}
                          {{ aviso.nombre[0].upper() }}
                        {% else %}
                          <i class="bi bi-person"></i>
                        {% endif %}
                      </div>
                    </div>
                    <div class="flex-grow-1 min-w-0">
                      <div class="d-flex justify-content-between align-items-start mb-1">
                        <div class="fw-semibold text-truncate">{{ aviso.nombre or 'Empleado desconocido' }}</div>
                        <div class="text-muted small ms-2 flex-shrink-0">{{ aviso.fecha.strftime('%H:%M') }}</div>
                      </div>
                      <div class="text-muted small text-truncate mb-2">DNI: {{ aviso.dni }}</div>
                      <div class="text-dark small mb-2">{{ aviso.mensaje[:80] }}{% if aviso.mensaje|length > 80 %}...{% endif %}</div>
                      <div class="d-flex gap-2">
                        {% if aviso.sector %}
                          <span class="badge bg-primary bg-opacity-10 text-primary small">
                            <i class="bi bi-briefcase me-1"></i>{{ aviso.sector }}
                          </span>
                        {% endif %}
                        {% if aviso.sucursal %}
                          <span class="badge bg-info bg-opacity-10 text-info small">
                            <i class="bi bi-geo-alt me-1"></i>{{ aviso.sucursal }}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                  <div class="avatar bg-light rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 64px; height: 64px;">
                    <i class="bi bi-chat-dots fs-2"></i>
                  </div>
                  <h6 class="mb-2">No hay mensajes recientes</h6>
                  <p class="small mb-0">Los mensajes enviados aparecer√°n aqu√≠</p>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Message Templates -->
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient-info text-white border-0">
              <h6 class="card-title mb-0 d-flex align-items-center">
                <i class="bi bi-file-text me-2"></i>
                Plantillas R√°pidas
              </h6>
            </div>
            <div class="card-body p-3">
              <div class="d-grid gap-2">
                <button class="btn btn-sm btn-outline-info text-start" onclick="loadTemplate('meeting')">
                  <i class="bi bi-calendar-event me-1"></i>
                  Recordatorio de reuni√≥n
                </button>
                <button class="btn btn-sm btn-outline-info text-start" onclick="loadTemplate('schedule')">
                  <i class="bi bi-clock me-1"></i>
                  Cambio de horario
                </button>
                <button class="btn btn-sm btn-outline-info text-start" onclick="loadTemplate('announcement')">
                  <i class="bi bi-megaphone me-1"></i>
                  Anuncio general
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== CSS Variables for Modern Design ===== */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  --info-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

  /* Enhanced shadows */
  --shadow-soft: 0 2px 15px rgba(0, 0, 0, 0.08);
  --shadow-medium: 0 4px 25px rgba(0, 0, 0, 0.12);
  --shadow-strong: 0 8px 35px rgba(0, 0, 0, 0.15);

  /* Transitions */
  --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* ===== Dark Mode Enhancements ===== */
[data-theme="dark"] {
  --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  --success-gradient: linear-gradient(135deg, #059669 0%, #10b981 100%);
  --info-gradient: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);

  --shadow-soft: 0 2px 15px rgba(0, 0, 0, 0.25);
  --shadow-medium: 0 4px 25px rgba(0, 0, 0, 0.35);
  --shadow-strong: 0 8px 35px rgba(0, 0, 0, 0.45);
}

/* ===== Base Styles ===== */
.fade-in-up {
  animation: fadeInUp 0.8s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ===== Cards ===== */
.card {
  border-radius: 16px;
  transition: var(--transition-smooth);
  backdrop-filter: blur(10px);
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-strong);
}

.bg-gradient-primary {
  background: var(--primary-gradient) !important;
}

.bg-gradient-success {
  background: var(--success-gradient) !important;
}

.bg-gradient-info {
  background: var(--info-gradient) !important;
}

/* ===== Recipient Selector ===== */
.recipient-selector {
  transition: var(--transition-smooth);
}

.employee-list-container {
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.employee-item {
  transition: var(--transition-smooth);
  cursor: pointer;
}

.employee-item:hover {
  background: rgba(59, 130, 246, 0.05);
  transform: translateX(4px);
}

.employee-item.selected {
  background: rgba(59, 130, 246, 0.1);
  border: 2px solid var(--primary-color);
}

.avatar-wrapper {
  position: relative;
  width: 32px;
  height: 32px;
}

.avatar-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border: 2px solid rgba(255, 255, 255, 0.8);
}

.cursor-pointer {
  cursor: pointer;
}

/* ===== Selected Recipients ===== */
.selected-recipients {
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.recipient-tag {
  background: var(--primary-gradient);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 20px;
  font-size: 0.75rem;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  margin: 0.125rem;
  animation: tagEnter 0.2s ease-out;
}

@keyframes tagEnter {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.recipient-tag .remove-btn {
  background: none;
  border: none;
  color: white;
  padding: 0;
  width: 14px;
  height: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  opacity: 0.8;
  transition: var(--transition-smooth);
}

.recipient-tag .remove-btn:hover {
  opacity: 1;
  background: rgba(255, 255, 255, 0.2);
}

/* ===== Message Editor ===== */
.message-editor .form-control {
  border-radius: 0 8px 8px 0;
  resize: vertical;
  min-height: 120px;
}

.message-editor .input-group-text {
  border-radius: 8px 0 0 8px;
}

/* ===== Preview Card ===== */
.preview-card {
  transition: var(--transition-smooth);
}

.preview-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-medium);
}

/* ===== Stat Cards ===== */
.stat-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
  backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  transition: var(--transition-bounce);
}

.stat-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: var(--shadow-strong);
}

.stat-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  background: rgba(255, 255, 255, 0.9);
  box-shadow: var(--shadow-medium);
  margin: 0 auto;
}

/* ===== Buttons ===== */
.btn {
  border-radius: 10px;
  font-weight: 600;
  transition: var(--transition-smooth);
  border: none;
  position: relative;
  overflow: hidden;
}

.btn-primary {
  background: var(--primary-gradient);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-outline-primary {
  border: 2px solid;
  background: transparent;
}

.btn-outline-primary:hover {
  background: var(--primary-gradient);
  color: white;
}

/* ===== Loading States ===== */
.btn:disabled {
  opacity: 0.7;
  transform: none !important;
}

#sendButton.loading {
  position: relative;
  color: transparent !important;
}

#sendButton.loading::after {
  content: "";
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid #ffffff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== Form Validation ===== */
.was-validated .form-control:valid {
  border-color: #198754;
  box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
}

.was-validated .form-control:invalid {
  border-color: #dc3545;
  box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

/* ===== Responsive Design ===== */
@media (max-width: 768px) {
  .recipient-selector {
    padding: 1rem;
  }

  .employee-list {
    max-height: 250px;
  }

  .stat-card .card-body {
    padding: 1.5rem 1rem;
  }

  .display-6 {
    font-size: 2rem;
  }

  .btn-group-vertical .btn {
    margin-bottom: 0.5rem;
  }

  .d-flex.flex-column.flex-sm-row {
    flex-direction: column !important;
  }

  .btn {
    width: 100%;
  }
}

@media (max-width: 576px) {
  .avatar-wrapper {
    width: 28px;
    height: 28px;
  }

  .employee-item {
    padding: 0.75rem;
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    font-size: 1.25rem;
  }

  .recipient-tag {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
  }
}

/* ===== Hover Effects ===== */
.hover-lift {
  transition: all var(--transition-fast);
}

.hover-lift:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md) !important;
}

/* ===== Avatar Styles ===== */
.avatar-wrapper {
  position: relative;
  width: 40px;
  height: 40px;
}

.avatar {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border: 2px solid var(--border-color);
  transition: all var(--transition-fast);
}

.avatar:hover {
  border-color: var(--primary-color);
  transform: scale(1.05);
}

/* ===== Dark Mode Specific ===== */
[data-theme="dark"] .recipient-selector {
  background: rgba(30, 41, 59, 0.6);
  border-color: rgba(71, 85, 105, 0.3);
}

[data-theme="dark"] .employee-list {
  background: rgba(15, 23, 42, 0.9);
}

[data-theme="dark"] .stat-card {
  background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
  border-color: rgba(71, 85, 105, 0.3);
}

[data-theme="dark"] .preview-card {
  background: rgba(30, 41, 59, 0.8);
  border-color: rgba(71, 85, 105, 0.3);
}

/* ===== Print Styles ===== */
@media print {
  .btn, .recipient-selector, .employee-list-container {
    display: none !important;
  }

  .card {
    box-shadow: none !important;
    border: 1px solid #ddd !important;
  }
}
</style>

<script>
// Global variables
let selectedEmployees = new Set();
let employeesData = [
  {% for empleado in empleados %}
  {
    dni: "{{ empleado.dni }}",
    nombre: "{{ empleado.nombre }}",
    sector: "{{ empleado.sector }}"
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  initializeRecipientSelector();
  initializeMessageEditor();
  initializeFormValidation();
  updateRecipientsCount();
});

// Recipient Selector Functions
function initializeRecipientSelector() {
  const searchInput = document.getElementById('employeeSearch');
  const employeeItems = document.querySelectorAll('.employee-item');

  // Search functionality
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    employeeItems.forEach(item => {
      const name = item.dataset.name.toLowerCase();
      const dni = item.dataset.dni;
      const isVisible = !searchTerm || name.includes(searchTerm) || dni.includes(searchTerm);
      item.style.display = isVisible ? '' : 'none';
    });
  });

  // Checkbox change handlers
  employeeItems.forEach(item => {
    const checkbox = item.querySelector('input[type="checkbox"]');
    const label = item.querySelector('.form-check-label');

    checkbox.addEventListener('change', function() {
      const dni = this.value;
      if (this.checked) {
        selectedEmployees.add(dni);
        item.classList.add('selected');
      } else {
        selectedEmployees.delete(dni);
        item.classList.remove('selected');
      }
      updateRecipientsDisplay();
      updateRecipientsCount();
      updateSendButton();
    });

    // Click on label also toggles checkbox
    label.addEventListener('click', function(e) {
      if (e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));
      }
    });
  });
}

function toggleEmployeeList() {
  const container = document.getElementById('employeeListContainer');
  const icon = document.getElementById('toggleIcon');

  if (container.style.display === 'none') {
    container.style.display = 'block';
    icon.className = 'bi bi-chevron-up';
  } else {
    container.style.display = 'none';
    icon.className = 'bi bi-chevron-down';
  }
}

function selectAllEmployees() {
  selectedEmployees.clear();
  employeesData.forEach(emp => selectedEmployees.add(emp.dni));
  updateCheckboxes();
  updateRecipientsDisplay();
  updateRecipientsCount();
  updateSendButton();
  showToast('Todos los empleados seleccionados', 'success');
}

function selectBySector(sector) {
  const sectorEmployees = employeesData.filter(emp => emp.sector === sector);
  sectorEmployees.forEach(emp => selectedEmployees.add(emp.dni));
  updateCheckboxes();
  updateRecipientsDisplay();
  updateRecipientsCount();
  updateSendButton();
  showToast(`${sectorEmployees.length} empleados de ${sector} seleccionados`, 'success');
}

function clearSelection() {
  selectedEmployees.clear();
  updateCheckboxes();
  updateRecipientsDisplay();
  updateRecipientsCount();
  updateSendButton();
  showToast('Selecci√≥n limpiada', 'info');
}

function updateCheckboxes() {
  document.querySelectorAll('.employee-item input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = selectedEmployees.has(checkbox.value);
    checkbox.closest('.employee-item').classList.toggle('selected', checkbox.checked);
  });
}

function updateRecipientsDisplay() {
  const container = document.getElementById('selectedRecipients');
  const tagsContainer = document.getElementById('recipientsTags');

  if (selectedEmployees.size === 0) {
    container.style.display = 'none';
    return;
  }

  container.style.display = 'block';
  tagsContainer.innerHTML = '';

  selectedEmployees.forEach(dni => {
    const employee = employeesData.find(emp => emp.dni === dni);
    if (employee) {
      const tag = document.createElement('span');
      tag.className = 'recipient-tag';
      tag.innerHTML = `
        ${employee.nombre}
        <button type="button" class="remove-btn" onclick="removeRecipient('${dni}')">
          <i class="bi bi-x"></i>
        </button>
      `;
      tagsContainer.appendChild(tag);
    }
  });
}

function removeRecipient(dni) {
  selectedEmployees.delete(dni);
  updateCheckboxes();
  updateRecipientsDisplay();
  updateRecipientsCount();
  updateSendButton();
}

function updateRecipientsCount() {
  const countElement = document.getElementById('recipientsCount');
  const count = selectedEmployees.size;
  countElement.textContent = `${count} seleccionados`;
  countElement.className = `badge ${count > 0 ? 'bg-primary' : 'bg-secondary'}`;
}

function updateSendButton() {
  const sendButton = document.getElementById('sendButton');
  const hasRecipients = selectedEmployees.size > 0;
  const hasMessage = document.getElementById('messageContent').value.trim().length > 0;

  sendButton.disabled = !hasRecipients || !hasMessage;
}

// Message Editor Functions
function initializeMessageEditor() {
  const textarea = document.getElementById('messageContent');
  const charCount = document.getElementById('charCount');

  textarea.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length}/500`;

    // Update color based on length
    if (length > 450) {
      charCount.className = 'text-danger fw-semibold';
    } else if (length > 400) {
      charCount.className = 'text-warning fw-semibold';
    } else {
      charCount.className = 'text-muted';
    }

    updateSendButton();
  });
}

function togglePreview() {
  const preview = document.getElementById('messagePreview');
  const content = document.getElementById('messageContent').value.trim();

  if (preview.style.display === 'none') {
    if (content) {
      document.getElementById('previewText').textContent = content;
      preview.style.display = 'block';
    } else {
      showToast('Escribe un mensaje primero', 'warning');
    }
  } else {
    preview.style.display = 'none';
  }
}

function saveDraft() {
  const message = document.getElementById('messageContent').value.trim();
  const recipients = Array.from(selectedEmployees);

  if (!message) {
    showToast('No hay mensaje para guardar', 'warning');
    return;
  }

  const draft = {
    message: message,
    recipients: recipients,
    timestamp: new Date().toISOString()
  };

  localStorage.setItem('messageDraft', JSON.stringify(draft));
  showToast('Borrador guardado', 'success');
}

function loadDraft() {
  const draft = localStorage.getItem('messageDraft');
  if (draft) {
    const data = JSON.parse(draft);
    document.getElementById('messageContent').value = data.message;
    selectedEmployees = new Set(data.recipients);
    updateCheckboxes();
    updateRecipientsDisplay();
    updateRecipientsCount();
    updateSendButton();
    showToast('Borrador cargado', 'info');
  }
}

function clearForm() {
  document.getElementById('messageContent').value = '';
  clearSelection();
  document.getElementById('messagePreview').style.display = 'none';
  document.getElementById('employeeSearch').value = '';
  showToast('Formulario limpiado', 'info');
}

// Template Functions
function loadTemplate(type) {
  const templates = {
    meeting: "üìÖ Recordatorio: Tienes una reuni√≥n programada para ma√±ana a las 9:00 AM en la sala de conferencias. Por favor, confirma tu asistencia.",
    schedule: "‚è∞ Cambio de horario: Informamos que a partir de la pr√≥xima semana, el horario de atenci√≥n al p√∫blico ser√° de 8:00 AM a 6:00 PM.",
    announcement: "üì¢ Anuncio importante: La empresa estar√° cerrada el pr√≥ximo viernes por mantenimiento. Disculpen las molestias."
  };

  document.getElementById('messageContent').value = templates[type] || '';
  document.getElementById('messageContent').dispatchEvent(new Event('input'));
  showToast('Plantilla cargada', 'success');
}

// Form Validation
function initializeFormValidation() {
  const form = document.getElementById('messageForm');

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    if (!form.checkValidity() || selectedEmployees.size === 0) {
      if (selectedEmployees.size === 0) {
        showToast('Selecciona al menos un destinatario', 'warning');
      }
      form.classList.add('was-validated');
      return;
    }

    // Show loading state
    const sendButton = document.getElementById('sendButton');
    const sendText = document.getElementById('sendText');
    const originalText = sendText.textContent;

    sendButton.disabled = true;
    sendButton.classList.add('loading');
    sendText.textContent = 'Enviando...';

    // Prepare form data
    const formData = new FormData();
    const mensaje = document.getElementById('messageContent').value.trim();
    formData.append('mensaje', mensaje);

    // Add selected employees as array
    console.log('Selected employees:', Array.from(selectedEmployees));
    let index = 0;
    selectedEmployees.forEach(dni => {
      formData.append(`dnis`, dni);
      console.log(`Adding DNI ${index}:`, dni);
      index++;
    });

    console.log('Sending message to', selectedEmployees.size, 'employees');

    // Send message to server
    fetch('/panel', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast(`Mensaje enviado correctamente a ${selectedEmployees.size} empleado${selectedEmployees.size !== 1 ? 's' : ''}`, 'success');
        clearForm();
      } else {
        showToast('Error al enviar mensaje: ' + (data.message || 'Error desconocido'), 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('Error de conexi√≥n al enviar mensaje', 'danger');
    })
    .finally(() => {
      // Restore button state
      sendButton.classList.remove('loading');
      sendButton.disabled = false;
      sendText.textContent = originalText;
    });
  });
}

// Utility Functions
function showHistory() {
  const historySection = document.getElementById('recentMessages');
  if (historySection) {
    historySection.scrollIntoView({ behavior: 'smooth' });
  }
}

function showToast(message, type = 'info') {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type} border-0`;
  toast.setAttribute('role', 'alert');
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
  `;

  // Add to container
  const container = document.querySelector('.toast-container') || createToastContainer();
  container.appendChild(toast);

  // Show toast
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();

  // Remove after hide
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

function createToastContainer() {
  const container = document.createElement('div');
  container.className = 'toast-container position-fixed top-0 end-0 p-3';
  container.style.zIndex = '9999';
  document.body.appendChild(container);
  return container;
}

// Load draft on page load
loadDraft();
</script>

{% endblock %}
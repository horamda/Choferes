{% extends 'base.html' %}

{% block title %}Editar Reuni√≥n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<style>
/* ===== CSS Variables for Modern Design ===== */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --info-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

  /* Enhanced shadows */
  --shadow-soft: 0 2px 15px rgba(0, 0, 0, 0.08);
  --shadow-medium: 0 4px 25px rgba(0, 0, 0, 0.12);
  --shadow-strong: 0 8px 35px rgba(0, 0, 0, 0.15);

  /* Transitions */
  --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* ===== Dark Mode Enhancements ===== */
[data-theme="dark"] {
  --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  --success-gradient: linear-gradient(135deg, #059669 0%, #10b981 100%);
  --warning-gradient: linear-gradient(135deg, #d97706 0%, #b45309 100%);
  --info-gradient: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);

  --shadow-soft: 0 2px 15px rgba(0, 0, 0, 0.25);
  --shadow-medium: 0 4px 25px rgba(0, 0, 0, 0.35);
  --shadow-strong: 0 8px 35px rgba(0, 0, 0, 0.45);
}
/* ===== Form Styles ===== */
.form-label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.required-field::after {
  content: " *";
  color: #dc3545;
  font-weight: bold;
}

.form-control, .form-select {
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 0.75rem;
  font-size: 0.95rem;
  transition: var(--transition-smooth);
  background: white;
}

.form-control:focus, .form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  transform: translateY(-1px);
}

/* ===== Grid System ===== */
.responsive-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: 1fr;
}

@media (min-width: 768px) {
  .responsive-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .responsive-grid.grid-3 {
    grid-template-columns: repeat(3, 1fr);
  }

  .responsive-grid.grid-2 {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ===== Map Styles ===== */
.map-section {
  background: white;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 1rem;
  margin-top: 0.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: var(--transition-smooth);
}

.map-section:hover {
  border-color: #dee2e6;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

#map-container {
  width: 100%;
  height: 400px;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  background: #f8f9fa;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
}

.map-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding: 0.5rem;
  background: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #e9ecef;
}

.map-controls .btn {
  flex: 1;
  min-width: 120px;
  font-size: 0.85rem;
  padding: 0.5rem 0.75rem;
}

/* ===== Character Counter ===== */
.char-counter {
  font-size: 0.8rem;
  color: #6c757d;
  text-align: right;
  margin-top: 0.25rem;
  font-weight: 500;
}

/* ===== Coordinate Input ===== */
.coordinate-input {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  background: #f8f9fa;
  font-weight: 500;
}

/* ===== Validation States ===== */
.form-control.is-invalid, .form-select.is-invalid {
  border-color: #dc3545;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.form-control.is-valid, .form-select.is-valid {
  border-color: #28a745;
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* ===== Loading States ===== */
.btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none !important;
}

/* ===== Responsive Design ===== */
@media (max-width: 767px) {
  .meeting-edit-container {
    padding: 0.5rem;
  }

  .form-content {
    padding: 1rem;
  }

  #map-container {
    height: 40vh;
    min-height: 250px;
  }

  .map-controls {
    flex-direction: column;
  }

  .map-controls .btn {
    min-width: auto;
  }
}

@media (max-width: 576px) {
  .d-flex.flex-column.flex-md-row {
    flex-direction: column !important;
  }

  .btn {
    width: 100%;
  }
}

/* ===== Map Info Overlay ===== */
.map-info-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  right: 10px;
  z-index: 1000;
  pointer-events: none;
}

.map-info-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 0.85rem;
  color: #495057;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  animation: fadeInDown 0.3s ease-out;
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeOutUp {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-10px);
  }
}

/* ===== Map Legend ===== */
.map-legend {
  background: rgba(248, 249, 250, 0.9);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(0, 0, 0, 0.08);
  border-radius: 8px;
  padding: 10px 15px;
  font-size: 0.85rem;
  line-height: 1.4;
}

/* ===== Map Status ===== */
.map-status {
  background: rgba(248, 249, 250, 0.95);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0, 0, 0, 0.08);
  border-radius: 8px;
  padding: 10px 15px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* ===== Enhanced Map Container ===== */
#map-container {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  background: #f8f9fa;
}

#map {
  border-radius: 12px;
  width: 100% !important;
  height: 100% !important;
}

/* ===== Map Controls Enhancement ===== */
.map-controls .btn {
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(0, 123, 255, 0.2);
}

.map-controls .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-color: rgba(0, 123, 255, 0.4);
}

.map-controls .btn:active {
  transform: translateY(0);
}

/* ===== Loading Animation Enhancement ===== */
.map-loading {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
}

/* ===== Fullscreen Styles ===== */
#map-container:fullscreen {
  border-radius: 0;
  box-shadow: none;
}

#map-container:fullscreen #map {
  border-radius: 0;
}

/* ===== Enhanced Map Controls ===== */
.map-controls .btn {
  transition: var(--transition-smooth);
  position: relative;
  overflow: hidden;
}

.map-controls .btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.map-controls .btn:active {
  transform: translateY(0);
}

/* ===== Dark Mode Support ===== */
[data-theme="dark"] .map-section {
  background: rgba(30, 41, 59, 0.6);
  border-color: rgba(71, 85, 105, 0.3);
}

[data-theme="dark"] .map-controls {
  background: rgba(30, 41, 59, 0.8);
  border-color: rgba(71, 85, 105, 0.3);
}

[data-theme="dark"] .map-info-content {
  background: rgba(30, 41, 59, 0.95);
  border-color: rgba(71, 85, 105, 0.3);
  color: #e2e8f0;
}

[data-theme="dark"] .map-status {
  background: rgba(30, 41, 59, 0.8);
  border-color: rgba(71, 85, 105, 0.3);
  color: #e2e8f0;
}

/* ===== Enhanced Responsive Design ===== */
@media (max-width: 767px) {
  .meeting-edit-container {
    padding: 0.5rem;
  }

  .form-content {
    padding: 1rem;
  }

  #map-container {
    height: 40vh;
    min-height: 280px;
  }

  .map-controls {
    flex-direction: column;
    width: 100%;
  }

  .map-controls .btn {
    flex: 1;
    justify-content: center;
    min-width: auto;
  }

  .map-info-overlay {
    top: 5px;
    left: 5px;
    right: 5px;
  }

  .map-info-content {
    font-size: 0.8rem;
    padding: 6px 10px;
  }

  .map-status {
    flex-direction: column;
    gap: 4px;
    align-items: stretch;
    text-align: center;
  }
}

@media (max-width: 576px) {
  .d-flex.flex-column.flex-md-row {
    flex-direction: column !important;
  }

  .btn {
    width: 100%;
  }

  #map-container {
    height: 35vh;
    min-height: 250px;
  }

  .map-controls {
    gap: 0.5rem;
  }

  .map-controls .btn {
    padding: 0.5rem;
    font-size: 0.8rem;
  }
}

/* ===== Progress Bar Animation ===== */
#formProgress {
  transition: width 0.3s ease;
}

/* ===== Enhanced Form Validation ===== */
.form-control.is-invalid {
  animation: shake 0.5s ease-in-out;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* ===== Loading States ===== */
.btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none !important;
}

#locationBtn.loading {
  position: relative;
  color: transparent !important;
}

#locationBtn.loading::after {
  content: "";
  position: absolute;
  width: 14px;
  height: 14px;
  top: 50%;
  left: 50%;
  margin-left: -7px;
  margin-top: -7px;
  border: 2px solid currentColor;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

/* ===== Map Theme Toggle ===== */
#themeMapBtn[data-theme="dark"] .bi-moon::before {
  content: "\f4a4"; /* sun icon */
}

#themeMapBtn[data-theme="light"] .bi-moon::before {
  content: "\f186"; /* moon icon */
}

#themeMapBtn[data-theme="satellite"] .bi-moon::before {
  content: "\f5ba"; /* globe icon */
}

/* ===== High DPI / Retina Display Support ===== */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .leaflet-container {
    font-size: 16px !important;
  }

  .leaflet-control-zoom a {
    background-size: 22px 22px !important;
  }

  .leaflet-control-attribution {
    font-size: 11px !important;
  }
}

/* ===== Enhanced Map Quality ===== */
.leaflet-container {
  font-family: inherit;
  height: 400px !important;
  width: 100% !important;
  max-width: 100% !important;
  border-radius: 12px;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  -ms-interpolation-mode: nearest-neighbor;
  image-rendering: pixelated;
  image-rendering: -moz-crisp-edges;
}

/* Mejorar calidad de tiles */
.leaflet-tile {
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  -ms-interpolation-mode: nearest-neighbor;
  image-rendering: -moz-crisp-edges;
  will-change: transform;
}

/* Mejorar calidad de marcadores */
.leaflet-marker-icon {
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  -ms-interpolation-mode: nearest-neighbor;
  image-rendering: -moz-crisp-edges;
}

/* Mejorar calidad de popups */
.leaflet-popup-content-wrapper {
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

.leaflet-popup-tip {
  background: white;
}

/* ===== Performance Optimizations ===== */
.leaflet-tile-container img {
  will-change: auto;
}

.leaflet-zoom-anim .leaflet-zoom-animated {
  will-change: transform;
}

/* ===== Better Mobile Experience ===== */
@media (max-width: 768px) {
  .leaflet-touch .leaflet-control-layers,
  .leaflet-touch .leaflet-bar {
    border-radius: 6px;
  }

  .leaflet-touch .leaflet-control-zoom a {
    width: 32px !important;
    height: 32px !important;
    line-height: 30px !important;
    font-size: 18px !important;
  }

  .leaflet-control-attribution {
    font-size: 9px !important;
    bottom: 2px !important;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="fade-in-up">
  <!-- Header Section -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3 mb-4">
    <div class="flex-grow-1">
      <h1 class="h3 mb-2 d-flex align-items-center gap-3">
        <i class="bi bi-pencil-square text-warning fs-4"></i>
        <div>
          <span class="fw-bold">Editar Reuni√≥n</span>
          <div class="text-muted small mt-1">Modifica los detalles de la reuni√≥n</div>
        </div>
      </h1>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a href="{{ url_for('admin_reuniones') }}" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-2">
        <i class="bi bi-arrow-left"></i>
        <span class="d-none d-sm-inline">Volver</span>
      </a>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="progress mb-4" style="height: 4px;">
    <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="formProgress"></div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-gradient-warning text-white border-0">
      <h5 class="card-title mb-0 d-flex align-items-center">
        <i class="bi bi-pencil-square me-2"></i>
        Editar Detalles de la Reuni√≥n
      </h5>
    </div>

    <div class="card-body p-4">
      <div class="meeting-edit-container">
        <div class="form-container">
        
        <!-- Contenido del formulario -->
        <div class="form-content">
            <form method="POST" action="{{ url_for('editar_reunion_admin', id=reunion.id) }}" class="needs-validation" novalidate>
                
                <!-- Informaci√≥n B√°sica -->
                <div class="form-section">
                    <h2 class="form-section-title">üìã Informaci√≥n B√°sica</h2>
                    
                    <div class="mb-3">
                        <label for="titulo" class="form-label required-field">T√≠tulo de la Reuni√≥n</label>
                        <input type="text" 
                               class="form-control" 
                               id="titulo" 
                               name="titulo" 
                               value="{{ reunion.titulo }}" 
                               maxlength="100" 
                               placeholder="Ej: Reuni√≥n semanal de equipo"
                               required>
                        <div class="char-counter">
                            <span id="titleCount">{{ reunion.titulo|length }}</span>/100 caracteres
                        </div>
                    </div>
                </div>
                
                <!-- Programaci√≥n -->
                <div class="form-section">
                    <h2 class="form-section-title">üìÖ Programaci√≥n</h2>
                    
                    <div class="responsive-grid grid-3">
                        <div>
                            <label for="frecuencia" class="form-label required-field">Frecuencia</label>
                            <select class="form-select" id="frecuencia" name="frecuencia" required>
                                <option value="">Seleccionar frecuencia</option>
                                <option value="diaria" {% if reunion.frecuencia == 'diaria' %}selected{% endif %}>üìÖ Diaria</option>
                                <option value="semanal" {% if reunion.frecuencia == 'semanal' %}selected{% endif %}>üìÜ Semanal</option>
                                <option value="mensual" {% if reunion.frecuencia == 'mensual' %}selected{% endif %}>üóìÔ∏è Mensual</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="dia_semana" class="form-label required-field">D√≠a de la Semana</label>
                            <select class="form-select" id="dia_semana" name="dia_semana" required>
                                <option value="">Seleccionar d√≠a</option>
                                <option value="0" {% if reunion.dia_semana == 0 %}selected{% endif %}>üåô Lunes</option>
                                <option value="1" {% if reunion.dia_semana == 1 %}selected{% endif %}>üî• Martes</option>
                                <option value="2" {% if reunion.dia_semana == 2 %}selected{% endif %}>‚ö° Mi√©rcoles</option>
                                <option value="3" {% if reunion.dia_semana == 3 %}selected{% endif %}>üöÄ Jueves</option>
                                <option value="4" {% if reunion.dia_semana == 4 %}selected{% endif %}>üéâ Viernes</option>
                                <option value="5" {% if reunion.dia_semana == 5 %}selected{% endif %}>üåÖ S√°bado</option>
                                <option value="6" {% if reunion.dia_semana == 6 %}selected{% endif %}>‚òÄÔ∏è Domingo</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="hora" class="form-label required-field">Hora</label>
                            <input type="time" 
                                   class="form-control" 
                                   id="hora" 
                                   name="hora" 
                                   value="{{ reunion.hora.strftime('%H:%M') if reunion.hora else '' }}" 
                                   required>
                        </div>
                    </div>
                </div>
                
                <!-- Ubicaci√≥n -->
                <div class="form-section">
                    <h2 class="form-section-title">üìç Ubicaci√≥n de la Reuni√≥n</h2>
                    
                    <div class="responsive-grid grid-2 mb-3">
                        <div>
                            <label for="latitud" class="form-label required-field custom-tooltip" data-tooltip="Coordenada Norte-Sur (-90 a 90)">
                                üåê Latitud
                            </label>
                            <input type="number" 
                                   class="form-control coordinate-input" 
                                   id="latitud" 
                                   name="latitud" 
                                   step="0.000001" 
                                   min="-90" 
                                   max="90" 
                                   value="{{ reunion.latitud }}" 
                                   placeholder="-34.603722"
                                   required>
                        </div>
                        
                        <div>
                            <label for="longitud" class="form-label required-field custom-tooltip" data-tooltip="Coordenada Este-Oeste (-180 a 180)">
                                üó∫Ô∏è Longitud
                            </label>
                            <input type="number" 
                                   class="form-control coordinate-input" 
                                   id="longitud" 
                                   name="longitud" 
                                   step="0.000001" 
                                   min="-180" 
                                   max="180" 
                                   value="{{ reunion.longitud }}" 
                                   placeholder="-58.381592"
                                   required>
                        </div>
                    </div>
                    
                    <div class="map-section">
                        <div class="d-flex flex-column gap-3 mb-3">
                            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                                <h3 class="mb-0 d-flex align-items-center">
                                    <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                                    Ubicaci√≥n en Mapa
                                </h3>
                                <div class="map-controls d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary d-flex align-items-center gap-1" onclick="getCurrentLocation()" id="locationBtn" title="Obtener mi ubicaci√≥n actual">
                                        <i class="bi bi-geo-alt"></i>
                                        <span class="d-none d-lg-inline">Mi ubicaci√≥n</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1" onclick="centerMap()" title="Centrar mapa en coordenadas">
                                        <i class="bi bi-bullseye"></i>
                                        <span class="d-none d-lg-inline">Centrar</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info d-flex align-items-center gap-1" onclick="toggleMapTheme()" id="themeMapBtn" data-theme="light" title="Cambiar tema del mapa">
                                        <i class="bi bi-moon"></i>
                                        <span class="d-none d-lg-inline">Tema</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning d-flex align-items-center gap-1" onclick="resetMapView()" title="Vista inicial del mapa">
                                        <i class="bi bi-house"></i>
                                        <span class="d-none d-lg-inline">Inicio</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1" onclick="fullscreenMap()" title="Pantalla completa">
                                        <i class="bi bi-arrows-fullscreen"></i>
                                        <span class="d-none d-lg-inline">Pantalla completa</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Map Legend / Info -->
                            <div class="map-legend d-flex flex-wrap gap-3 text-muted small">
                                <div class="d-flex align-items-center gap-1">
                                    <i class="bi bi-mouse text-primary"></i>
                                    <span>Click para mover marcador</span>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <i class="bi bi-arrows-move text-success"></i>
                                    <span>Arrastra para navegar</span>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <i class="bi bi-zoom-in text-info"></i>
                                    <span>Rueda para zoom</span>
                                </div>
                            </div>
                        </div>

                        <div id="map-container" class="position-relative">
                            <div class="map-loading" id="mapLoading">
                                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Cargando mapa...</span>
                                    </div>
                                    <div class="text-muted">Cargando mapa interactivo...</div>
                                    <div class="text-muted small mt-1">Aseg√∫rate de tener conexi√≥n a internet</div>
                                </div>
                            </div>
                            <div id="map"></div>

                            <!-- Map Info Overlay -->
                            <div class="map-info-overlay" id="mapInfoOverlay">
                                <div class="map-info-content">
                                    <i class="bi bi-info-circle text-info me-2"></i>
                                    <span>Arrastra el marcador o haz click en el mapa para cambiar la ubicaci√≥n</span>
                                </div>
                            </div>
                        </div>

                        <!-- Map Status -->
                        <div class="map-status mt-3 d-flex justify-content-between align-items-center">
                            <div class="map-coordinates text-muted small" id="mapCoordinates">
                                <i class="bi bi-geo-alt me-1"></i>
                                Coordenadas: <span id="coordDisplay">--</span>
                            </div>
                            <div class="map-zoom text-muted small" id="mapZoom">
                                <i class="bi bi-zoom-in me-1"></i>
                                Zoom: <span id="zoomDisplay">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
          <!-- Botones de Acci√≥n -->
          <div class="d-flex flex-column flex-md-row gap-3 justify-content-between align-items-center mt-4 pt-4 border-top">
            <a href="{{ url_for('admin_reuniones') }}" class="btn btn-outline-secondary d-flex align-items-center gap-2">
              <i class="bi bi-arrow-left"></i>
              <span>Volver al listado</span>
            </a>

            <div class="d-flex gap-2">
              <a href="{{ url_for('regenerar_qr_reunion', id_reunion=reunion.id) }}" class="btn btn-outline-info d-flex align-items-center gap-2">
                <i class="bi bi-qr-code"></i>
                <span class="d-none d-sm-inline">Regenerar QR</span>
              </a>
              <button type="submit" class="btn btn-primary d-flex align-items-center gap-2" id="submitBtn">
                <i class="bi bi-save"></i>
                <span>Guardar Cambios</span>
              </button>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
(function () {
  'use strict';

  const mapConfig = {
    defaultLat: -34.6037,
    defaultLng: -58.3816,
    defaultZoom: 15,
    minZoom: 3,
    maxZoom: 19
  };

  const tileLayerConfigs = {
    light: {
      url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      options: {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors',
        maxZoom: 19
      }
    },
    dark: {
      url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
      options: {
        attribution: '&copy; <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> contributors',
        maxZoom: 19
      }
    }
  };

  let map;
  let marker;
  let currentTheme = 'light';
  let currentTileLayer;
  let initialCoords = null;
  let isMapReady = false;

  function parseCoordinate(value) {
    if (typeof value === 'number') {
      return value;
    }
    if (typeof value !== 'string') {
      return NaN;
    }
    return parseFloat(value.replace(',', '.'));
  }

  function readInputCoordinates() {
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    if (!latInput || !lngInput) {
      return null;
    }

    const lat = parseCoordinate(latInput.value);
    const lng = parseCoordinate(lngInput.value);

    if (Number.isFinite(lat) && Number.isFinite(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
      return { lat, lng };
    }

    return null;
  }

  function createTileLayer(theme) {
    const config = tileLayerConfigs[theme];
    if (!config) {
      return null;
    }
    return L.tileLayer(config.url, config.options);
  }

  function hideMapLoading() {
    const loading = document.getElementById('mapLoading');
    if (loading) {
      loading.classList.add('d-none');
    }
  }

  function hideMapOverlay() {
    const overlay = document.getElementById('mapInfoOverlay');
    if (overlay) {
      overlay.style.opacity = '0';
      overlay.style.transition = 'opacity 0.3s ease';
      window.setTimeout(() => {
        overlay.style.display = 'none';
      }, 320);
    }
  }

  function updateCoordinateDisplay(latlng) {
    const coordDisplay = document.getElementById('coordDisplay');
    if (coordDisplay && latlng) {
      coordDisplay.textContent = `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}`;
    }
  }

  function updateZoomDisplay(zoom) {
    const zoomDisplay = document.getElementById('zoomDisplay');
    if (zoomDisplay && Number.isFinite(zoom)) {
      zoomDisplay.textContent = Math.round(zoom);
    }
  }

  function syncInputs(latlng) {
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    if (!latInput || !lngInput || !latlng) {
      return;
    }

    latInput.value = latlng.lat.toFixed(6);
    lngInput.value = latlng.lng.toFixed(6);
    updateCoordinateDisplay(latlng);
  }

  function updateThemeButton() {
    const themeBtn = document.getElementById('themeMapBtn');
    if (!themeBtn) {
      return;
    }

    const icon = themeBtn.querySelector('i');
    const titles = {
      light: 'Cambiar a mapa oscuro',
      dark: 'Cambiar a mapa claro'
    };
    const icons = {
      light: 'bi-sun',
      dark: 'bi-moon'
    };

    themeBtn.setAttribute('data-theme', currentTheme);
    themeBtn.title = titles[currentTheme] || 'Cambiar tema del mapa';

    if (icon) {
      icon.className = i ;
    }
  }

  function initMap() {
    if (typeof L === 'undefined') {
      console.error('Leaflet no est? disponible');
      const mapContainer = document.getElementById('map');
      if (mapContainer) {
        mapContainer.innerHTML = '<div class="alert alert-danger mb-0">No se pudo cargar el mapa interactivo.</div>';
      }
      return;
    }

    const coords = readInputCoordinates() || { lat: mapConfig.defaultLat, lng: mapConfig.defaultLng };
    initialCoords = { ...coords };

    map = L.map('map', {
      center: [coords.lat, coords.lng],
      zoom: mapConfig.defaultZoom,
      minZoom: mapConfig.minZoom,
      maxZoom: mapConfig.maxZoom,
      zoomControl: true
    });

    currentTileLayer = createTileLayer(currentTheme);
    if (currentTileLayer) {
      currentTileLayer.on('load', () => {
        hideMapLoading();
        if (!isMapReady) {
          isMapReady = true;
          window.setTimeout(hideMapOverlay, 3500);
        }
      });
      currentTileLayer.addTo(map);
    }

    marker = L.marker([coords.lat, coords.lng], { draggable: true }).addTo(map);

    marker.on('dragend', (event) => {
      syncInputs(event.target.getLatLng());
    });

    map.on('click', (event) => {
      marker.setLatLng(event.latlng);
      syncInputs(event.latlng);
    });

    map.on('moveend', () => {
      updateCoordinateDisplay(map.getCenter());
    });

    map.on('zoomend', () => {
      updateZoomDisplay(map.getZoom());
    });

    updateCoordinateDisplay(map.getCenter());
    updateZoomDisplay(map.getZoom());
    updateThemeButton();

    map.whenReady(() => {
      window.requestAnimationFrame(() => {
        map.invalidateSize();
      });
    });
  }

  window.centerMap = function centerMap() {
    if (!map) {
      alert('El mapa todav?a no est? listo.');
      return;
    }

    const coords = readInputCoordinates();
    if (!coords) {
      alert('Las coordenadas ingresadas no son v?lidas.');
      return;
    }

    map.setView([coords.lat, coords.lng], map.getZoom(), { animate: true });
    marker.setLatLng([coords.lat, coords.lng]);
    updateCoordinateDisplay(coords);
  };

  window.resetMapView = function resetMapView() {
    if (!map || !initialCoords) {
      alert('El mapa todav?a no est? listo.');
      return;
    }

    map.setView([initialCoords.lat, initialCoords.lng], mapConfig.defaultZoom, { animate: true });
    marker.setLatLng([initialCoords.lat, initialCoords.lng]);
    updateCoordinateDisplay(initialCoords);
    updateZoomDisplay(mapConfig.defaultZoom);
  };

  window.toggleMapTheme = function toggleMapTheme() {
    if (!map) {
      alert('El mapa todav?a no est? listo.');
      return;
    }

    const nextTheme = currentTheme === 'light' ? 'dark' : 'light';
    const nextLayer = createTileLayer(nextTheme);
    if (!nextLayer) {
      alert('No se pudo cambiar el tema del mapa.');
      return;
    }

    if (currentTileLayer) {
      map.removeLayer(currentTileLayer);
    }

    nextLayer.addTo(map);
    currentTileLayer = nextLayer;
    currentTheme = nextTheme;
    updateThemeButton();
  };

  window.fullscreenMap = function fullscreenMap() {
    const container = document.getElementById('map-container');
    if (!container) {
      return;
    }

    if (document.fullscreenElement === container) {
      document.exitFullscreen();
    } else {
      if (container.requestFullscreen) {
        container.requestFullscreen();
      }
    }
  };

  window.getCurrentLocation = function getCurrentLocation() {
    if (!navigator.geolocation) {
      alert('Este navegador no soporta geolocalizaci?n.');
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const latlng = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        if (map) {
          map.setView([latlng.lat, latlng.lng], 16, { animate: true });
          marker.setLatLng([latlng.lat, latlng.lng]);
        }

        syncInputs(latlng);
      },
      () => {
        alert('No se pudo obtener tu ubicaci?n.');
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  };

  function setupCoordinateInputs() {
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    if (!latInput || !lngInput) {
      return;
    }

    const handleChange = () => {
      const coords = readInputCoordinates();
      if (!coords || !map) {
        return;
      }
      map.setView([coords.lat, coords.lng], map.getZoom(), { animate: true });
      marker.setLatLng([coords.lat, coords.lng]);
      updateCoordinateDisplay(coords);
    };

    latInput.addEventListener('change', handleChange);
    lngInput.addEventListener('change', handleChange);
  }

  function setupCharacterCounter() {
    const titleInput = document.getElementById('titulo');
    const counter = document.getElementById('titleCount');
    if (!titleInput || !counter) {
      return;
    }

    const updateCounter = () => {
      const length = titleInput.value.length;
      counter.textContent = length;
      counter.style.color = length > 90 ? '#dc3545' : length > 75 ? '#ffc107' : '#6c757d';
    };

    titleInput.addEventListener('input', updateCounter);
    updateCounter();
  }

  function setupBasicFormValidation() {
    const form = document.querySelector('form');
    if (!form) {
      return;
    }

    form.addEventListener('submit', (event) => {
      if (!form.checkValidity() || !readInputCoordinates()) {
        event.preventDefault();
        event.stopPropagation();
        alert('Por favor, revisa los campos del formulario.');
        return false;
      }

      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
      }

      return true;
    });
  }

  function setupFormProgressTracking() {
    const progressBar = document.getElementById('formProgress');
    const form = document.querySelector('form');
    if (!progressBar || !form) {
      return;
    }

    const requiredFields = Array.from(form.querySelectorAll('input[required], select[required], textarea[required]'));

    const update = () => {
      if (!requiredFields.length) {
        return;
      }
      const completed = requiredFields.filter((field) => field.value.trim()).length;
      const percentage = Math.round((completed / requiredFields.length) * 100);
      progressBar.style.width = `${percentage}%`;

      progressBar.classList.remove('bg-danger', 'bg-warning', 'bg-info', 'bg-success');
      if (percentage < 30) {
        progressBar.classList.add('bg-danger');
      } else if (percentage < 70) {
        progressBar.classList.add('bg-warning');
      } else if (percentage < 100) {
        progressBar.classList.add('bg-info');
      } else {
        progressBar.classList.add('bg-success');
      }
    };

    form.addEventListener('input', update);
    update();
  }

  document.addEventListener('fullscreenchange', () => {
    if (map) {
      window.setTimeout(() => map.invalidateSize(), 120);
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    initMap();
    setupCoordinateInputs();
    setupCharacterCounter();
    setupFormProgressTracking();
    setupBasicFormValidation();
  });
})();
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}KPIs de Empleado por DNI{% endblock %}
{% block header %}ðŸ“Š KPIs de Empleado por DNI{% endblock %}

{% block content %}
<div class="mb-3">
  <label for="dniInput" class="form-label">Buscar por DNI</label>
  <div class="input-group">
    <input type="text" id="dniInput" class="form-control" placeholder="DNI del empleado">
    <button class="btn btn-primary" onclick="cargarKPIs()">Buscar</button>
  </div>
</div>

<div id="contenedorTarjetas" class="row mb-4"></div>
<div id="contenedorGraficos" class="row"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const charts = [];

  function sanitizeId(str) {
    return str.replace(/[^a-zA-Z0-9]/g, "_");
  }

  async function cargarKPIs() {
    const dni = document.getElementById("dniInput").value.trim();
    if (!dni) return alert("Ingrese un DNI vÃ¡lido");

    const tarjetasCont = document.getElementById("contenedorTarjetas");
    const graficosCont = document.getElementById("contenedorGraficos");
    tarjetasCont.innerHTML = "";
    graficosCont.innerHTML = "";
    charts.forEach(c => c.destroy());
    charts.length = 0;

    try {
      const res = await fetch(`/api/kpis_por_dni/${dni}`);
      const data = await res.json();

      if (!data.tarjetas || data.tarjetas.length === 0) {
        tarjetasCont.innerHTML = '<div class="alert alert-warning">No hay datos disponibles para este empleado.</div>';
        return;
      }

      for (const t of data.tarjetas) {
        const canvasId = `grafico_${sanitizeId(t.indicador)}`;

        tarjetasCont.insertAdjacentHTML("beforeend", `
          <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary">
              <div class="card-body">
                <h6 class="card-title">${t.indicador}</h6>
                <h4>${t.valor}</h4>
              </div>
            </div>
          </div>
        `);

        graficosCont.insertAdjacentHTML("beforeend", `
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-body">
                <h6>${t.indicador}</h6>
                <canvas id="${canvasId}"></canvas>
              </div>
            </div>
          </div>
        `);

        const serieResp = await fetch(`/api/serie_indicador?indicador_id=${t.indicador_id}&dni=${dni}`);
        const serie = await serieResp.json();

        const ctx = document.getElementById(canvasId)?.getContext("2d");
        if (!ctx || !serie?.labels?.length) continue;

        const chart = new Chart(ctx, {
          type: serie.tipo || 'bar',
          data: {
            labels: serie.labels,
            datasets: [{
              label: t.indicador,
              data: serie.data,
              backgroundColor: serie.color || '#0d6efd',
              borderColor: serie.color || '#0d6efd',
              fill: serie.fill || false,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true }
            }
          }
        });

        charts.push(chart);
      }
    } catch (e) {
      tarjetasCont.innerHTML = '<div class="alert alert-danger">Error al cargar datos.</div>';
    }
  }
</script>
{% endblock %}

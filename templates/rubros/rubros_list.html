{% extends "base.html" %}
{% block title %}Rubros{% endblock %}
{% block header %}üè∑Ô∏è Rubros{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Rubros</h2>
    <button class="btn btn-primary btn-modern" onclick="abrirFormularioRubro()">‚ûï Nuevo Rubro</button>
  </div>

  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle text-center mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Descripci√≥n</th>
              <th style="width: 150px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="rubrosBody">
            {% for r in rubros %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.nombre }}</td>
              <td>{{ r.descripcion or "" }}</td>
              <td>
                <button class="btn btn-sm btn-warning me-1" onclick="editarRubro({{r.id}}, '{{r.nombre}}', '{{r.descripcion}}')">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="eliminarRubro({{r.id}})">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Rubro -->
<div class="modal fade" id="rubroModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="formRubro">
        <div class="modal-header">
          <h5 class="modal-title">Rubro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="rubroId">
          <div class="mb-3">
            <label for="nombre" class="form-label fw-bold">Nombre</label>
            <input type="text" class="form-control" id="nombre" placeholder="Ej: Electricidad" required>
          </div>
          <div class="mb-3">
            <label for="descripcion" class="form-label fw-bold">Descripci√≥n</label>
            <textarea class="form-control" id="descripcion" rows="3" placeholder="Detalle del rubro..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const API_RUBROS = "/api/rubros";

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("formRubro").addEventListener("submit", guardarRubro);
});

function abrirFormularioRubro() {
  document.getElementById("rubroId").value = "";
  document.getElementById("formRubro").reset();
  document.querySelector("#rubroModal .modal-title").innerText = "Nuevo Rubro";
  new bootstrap.Modal(document.getElementById("rubroModal")).show();
}

function editarRubro(id, nombre, descripcion) {
  document.getElementById("rubroId").value = id;
  document.getElementById("nombre").value = nombre;
  document.getElementById("descripcion").value = descripcion !== "None" ? descripcion : "";
  document.querySelector("#rubroModal .modal-title").innerText = "Editar Rubro";
  new bootstrap.Modal(document.getElementById("rubroModal")).show();
}

function guardarRubro(e) {
  e.preventDefault();
  const id = document.getElementById("rubroId").value;
  const rubro = {
    nombre: document.getElementById("nombre").value,
    descripcion: document.getElementById("descripcion").value
  };

  fetch(id ? `${API_RUBROS}/${id}` : API_RUBROS, {
    method: id ? "PUT" : "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(rubro)
  }).then(() => {
    bootstrap.Modal.getInstance(document.getElementById("rubroModal")).hide();
    location.reload();
  });
}

function eliminarRubro(id) {
  if (!confirm("¬øSeguro que quieres eliminar este rubro?")) return;
  fetch(`${API_RUBROS}/${id}`, { method: "DELETE" }).then(() => location.reload());
}
</script>
{% endblock %}
